<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Taj Sons</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a1a1a;
            --accent: #c9a227;
            --bg: #f4f6f8;
            --text: #333;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            background: var(--bg);
            color: var(--text);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--primary);
            color: white;
            height: 100vh;
            padding: 30px 20px;
            position: fixed;
        }

        .sidebar h2 {
            margin-bottom: 40px;
            color: var(--accent);
            text-align: center;
            letter-spacing: 1px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar li {
            margin: 10px 0;
        }

        .sidebar a {
            color: #aaa;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            transition: 0.3s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: #333;
            color: white;
        }

        .sidebar a.active {
            border-left: 4px solid var(--accent);
        }

        /* Main Content */
        .main-content {
            margin-left: 300px;
            padding: 40px;
            width: calc(100% - 300px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
        }

        .stat-card p {
            margin: 10px 0 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* Tables */
        .card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #666;
        }

        .thumb {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            object-fit: cover;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #e6f7ed;
            color: #1fb468;
        }

        .badge-danger {
            background: #feecef;
            color: #eb3b5a;
        }

        .badge-warning {
            background: #fff8e1;
            color: #fbc02d;
        }

        .badge-info {
            background: #e1f5fe;
            color: #039be5;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn:hover {
            background: #b59021;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 550px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        /* Generic Action Modal */
        #action-modal .modal-content {
            width: 400px;
            text-align: center;
        }

        /* Success Toast */
        #success-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1fb468;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(31, 180, 104, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            transition: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #success-toast.active {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>Taj Sons</h2>
        <ul>
            <li><a href="#" id="link-products" class="active" onclick="showTab(event, 'products')"><i
                        class="fas fa-box"></i> Products</a></li>
            <li><a href="#" id="link-orders" onclick="showTab(event, 'orders')"><i class="fas fa-shopping-cart"></i>
                    Orders</a></li>
            <li><a href="#" id="link-sales" onclick="showTab(event, 'sales')"><i class="fas fa-chart-line"></i> Sales
                    Report</a></li>
            <li><a href="#" id="link-inventory" onclick="showTab(event, 'inventory')"><i class="fas fa-warehouse"></i>
                    Inventory</a></li>
        </ul>
    </div>

    <div class="main-content">

        <!-- Products Tab -->
        <div id="products" class="tab-content active">
            <div class="header">
                <h1>Manage Products</h1>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="openAddProductModal()">
                        <i class="fas fa-plus"></i> Add New Product
                    </button>
                    <button class="btn btn-outline" onclick="scanProducts()">
                        <i class="fas fa-sync"></i> Scan Folder
                    </button>
                </div>
            </div>

            <div class="card">
                <div style="padding: 15px; border-bottom: 1px solid #eee;">
                    <input type="text" id="admin-product-search" placeholder="Search products by name or category..."
                        onkeyup="filterAdminProducts()"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-product-list">
                        <tr>
                            <td colspan="5">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="tab-content">
            <div class="header">
                <h1>Order History</h1>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="admin-order-list">
                        <tr>
                            <td colspan="5">No orders found yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="sales" class="tab-content">
            <div class="header">
                <h1>Sales Analytics</h1>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <p id="stat-revenue">Rs. 0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <p id="stat-orders">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Products</h3>
                    <p id="stat-products">0</p>
                </div>
            </div>
            <div class="card" style="padding: 20px;">
                <h3>Store Performance Insights</h3>
                <p>Welcome to your sales dashboard. Here you can track how Taj Sons is performing.</p>
                <div id="sales-message" style="margin-top: 10px; font-style: italic; color: #666;">
                    "AI Tip: Your 'Under Cabinet' items are your best sellers this week!"
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div id="inventory-main-view">
                <div class="header">
                    <h1>Inventory Control</h1>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Current Price</th>
                                <th>Stock Status</th>
                                <th>Interest/Demand</th>
                                <th>Update</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list">
                            <tr>
                                <td colspan="5">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Full Section Leads View -->
            <div id="inventory-leads-view" style="display:none;">
                <div class="header">
                    <div style="display:flex; align-items:center; gap: 15px;">
                        <button class="btn btn-outline" onclick="backToInventory()" style="padding: 8px 12px;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h1 style="margin:0">Waitlist: <span id="leads-product-name-heading"
                                style="color:var(--accent)"></span></h1>
                    </div>
                    <button class="btn btn-danger" id="clear-leads-btn" style="background:#ff4757;"
                        onclick="clearInterests()">
                        <i class="fas fa-trash"></i> Clear All Leads
                    </button>
                </div>

                <div class="card">
                    <table style="width:100%">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>WhatsApp Number</th>
                                <th>Date Joined</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="full-leads-list">
                            <!-- Leads go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- SEO Modal -->
    <div id="seo-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">‚ú® AI Auto-SEO Specialist</h2>
            <p>I am optimizing: <b id="seo-product-name" style="color:var(--accent)"></b></p>
            <hr style="border:0.5px solid #eee; margin: 20px 0;">

            <div id="seo-loading" style="text-align:center; padding: 20px;">
                <i class="fas fa-robot fa-spin" style="font-size: 2rem; color: var(--accent);"></i>
                <p>Analyzing product details and writing SEO magic...</p>
            </div>

            <div id="seo-result" style="display: none;">
                <label style="font-weight:600">Premium Description:</label>
                <textarea id="seo-desc" rows="6"
                    style="width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 10px 0; font-family: inherit;"></textarea>

                <label style="font-weight:600">Search Keywords (Tags):</label>
                <input type="text" id="seo-tags"
                    style="width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 10px 0;">

                <div style="display:flex; gap:10px; margin-top: 20px;">
                    <button class="btn" style="flex:1" onclick="saveSeo()"><i class="fas fa-save"></i> Apply to
                        Website</button>
                    <button class="btn btn-outline" onclick="closeSeo()">Discard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <h2 id="product-modal-title" style="margin-top:0">Add New Product</h2>
            <form id="product-form" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="edit-product-id">

                <label style="display:block; margin: 10px 0 5px; font-weight:600;">Product Name</label>
                <input type="text" id="p-name" required placeholder="e.g. Wooden Fruit Basket"
                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label style="display:block; margin: 10px 0 5px; font-weight:600;">Price (PKR)</label>
                        <input type="number" id="p-price" required placeholder="900"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    </div>
                    <div style="flex:1">
                        <label style="display:block; margin: 10px 0 5px; font-weight:600;">Category</label>
                        <input type="text" id="p-category" required placeholder="Organizers"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    </div>
                </div>

                <label style="display:block; margin: 10px 0 5px; font-weight:600;">Description</label>
                <textarea id="p-desc" rows="3" placeholder="Describe your product..."
                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-family:inherit;"></textarea>

                <label style="display:block; margin: 10px 0 5px; font-weight:600;">Product Photos (Up to 5)</label>
                <div id="photo-slots"
                    style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 5px;">
                    <!-- Slot 1 -->
                    <div style="text-align: center;">
                        <div class="photo-slot" onclick="document.getElementById('p-image-1').click()"
                            style="border: 2px dashed #ddd; aspect-ratio: 1; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fafafa;">
                            <i class="fas fa-camera" id="icon-1" style="color: #ccc; font-size: 1.2rem;"></i>
                            <img id="prev-1" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                            <input type="file" id="p-image-1" accept="image/*" hidden onchange="previewSlot(1)">
                        </div>
                        <span style="font-size: 0.65rem; color: #888;">Main Cover</span>
                    </div>
                    <!-- Slot 2 -->
                    <div style="text-align: center;">
                        <div class="photo-slot" onclick="document.getElementById('p-image-2').click()"
                            style="border: 2px dashed #ddd; aspect-ratio: 1; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fafafa;">
                            <i class="fas fa-camera" id="icon-2" style="color: #ccc; font-size: 1.2rem;"></i>
                            <img id="prev-2" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                            <input type="file" id="p-image-2" accept="image/*" hidden onchange="previewSlot(2)">
                        </div>
                        <span style="font-size: 0.65rem; color: #888;">Photo 2</span>
                    </div>
                    <!-- Slot 3 -->
                    <div style="text-align: center;">
                        <div class="photo-slot" onclick="document.getElementById('p-image-3').click()"
                            style="border: 2px dashed #ddd; aspect-ratio: 1; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fafafa;">
                            <i class="fas fa-camera" id="icon-3" style="color: #ccc; font-size: 1.2rem;"></i>
                            <img id="prev-3" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                            <input type="file" id="p-image-3" accept="image/*" hidden onchange="previewSlot(3)">
                        </div>
                        <span style="font-size: 0.65rem; color: #888;">Photo 3</span>
                    </div>
                    <!-- Slot 4 -->
                    <div style="text-align: center;">
                        <div class="photo-slot" onclick="document.getElementById('p-image-4').click()"
                            style="border: 2px dashed #ddd; aspect-ratio: 1; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fafafa;">
                            <i class="fas fa-camera" id="icon-4" style="color: #ccc; font-size: 1.2rem;"></i>
                            <img id="prev-4" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                            <input type="file" id="p-image-4" accept="image/*" hidden onchange="previewSlot(4)">
                        </div>
                        <span style="font-size: 0.65rem; color: #888;">Photo 4</span>
                    </div>
                    <!-- Slot 5 -->
                    <div style="text-align: center;">
                        <div class="photo-slot" onclick="document.getElementById('p-image-5').click()"
                            style="border: 2px dashed #ddd; aspect-ratio: 1; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fafafa;">
                            <i class="fas fa-camera" id="icon-5" style="color: #ccc; font-size: 1.2rem;"></i>
                            <img id="prev-5" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                            <input type="file" id="p-image-5" accept="image/*" hidden onchange="previewSlot(5)">
                        </div>
                        <span style="font-size: 0.65rem; color: #888;">Photo 5</span>
                    </div>
                </div>
                <p id="edit-img-note" style="font-size: 0.75rem; color: #777; margin-top: 5px; display:none;">Leave
                    blank to keep existing photos.</p>

                <div style="display:flex; gap:10px; margin-top:25px;">
                    <button type="submit" class="btn" style="flex:1">Save Product</button>
                    <button type="button" class="btn btn-outline" onclick="closeProductModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Items Modal -->
    <div id="order-items-modal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0">Order Details <span id="order-id-display"
                        style="color:var(--accent); font-size: 0.9rem;"></span></h2>
                <button class="btn btn-outline" onclick="closeOrderItems()">Close</button>
            </div>
            <hr style="border:0.5px solid #eee; margin: 20px 0;">

            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="order-items-list">
                        <!-- Items go here -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 20px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="font-weight:600; font-size: 0.9rem;">Update Status:</label>
                    <select id="order-status-select" onchange="updateOrderStatusFromModal()"
                        style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                        <option value="Pending (WhatsApp Confirmation)">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button class="btn" style="background:#25D366; padding: 8px 12px; font-size: 0.8rem;"
                        onclick="notifyStatusWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Notify Customer
                    </button>
                </div>
                <div style="font-weight: 600; font-size: 1.2rem;">
                    Total: <span id="order-total-display"></span>
                </div>
            </div>
        </div>
    </div>


    <!-- Generic Action Confirm Modal -->
    <div id="action-modal" class="modal">
        <div class="modal-content">
            <div id="action-modal-icon" style="font-size: 3rem; margin-bottom: 20px;"></div>
            <h2 id="action-modal-title" style="margin-top:0">Are you sure?</h2>
            <p id="action-modal-text" style="color:#666; line-height:1.5;"></p>
            <div style="display:flex; gap:10px; margin-top:30px;">
                <button id="action-modal-confirm" class="btn" style="flex:1">Yes, Proceed</button>
                <button class="btn btn-outline" onclick="closeActionModal()" style="flex:1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="success-toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Action Successful!</span>
    </div>

    <script src="../config.js"></script>
    <script>
        let allProducts = [];
        let allOrders = [];
        let currentLeadsProductId = null;
        let currentLeadsProductName = "";
        let currentOrderId = null;

        // Tab System
        function showTab(e, tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            if (e && e.currentTarget) {
                e.currentTarget.classList.add('active');
            }

            if (tabId === 'products' || tabId === 'inventory') loadProducts();
            if (tabId === 'orders') loadOrders();
            if (tabId === 'sales') calculateStats();
        }

        // Helper: Show custom confirm modal
        function showConfirm(title, text, iconClass, color, onConfirm) {
            document.getElementById('action-modal-title').textContent = title;
            document.getElementById('action-modal-text').textContent = text;
            const icon = document.getElementById('action-modal-icon');
            icon.innerHTML = `<i class="${iconClass}"></i>`;
            icon.style.color = color;

            const confirmBtn = document.getElementById('action-modal-confirm');
            confirmBtn.style.background = color;
            confirmBtn.onclick = () => {
                onConfirm();
                closeActionModal();
            };

            document.getElementById('action-modal').style.display = 'flex';
        }

        function closeActionModal() {
            document.getElementById('action-modal').style.display = 'none';
        }

        // Helper: Show success toast
        function showToast(message) {
            const toast = document.getElementById('success-toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                allProducts = await res.json();

                // Products Tab
                const productList = document.getElementById('admin-product-list');
                productList.innerHTML = allProducts.map(p => `
                    <tr>
                        <td><img src="/products/${p.image}" class="thumb"></td>
                        <td><b>${p.name}</b></td>
                        <td>${p.category}</td>
                        <td>
                            <span class="badge ${p.inStock ? 'badge-success' : 'badge-danger'}">
                                ${p.inStock ? 'In Stock' : 'Out of Stock'}
                            </span>
                        </td>
                        <td>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-outline" style="padding: 5px 8px; font-size: 0.75rem;" onclick="openEditProductModal('${p.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline" style="padding: 5px 8px; font-size: 0.75rem;" onclick="openSeo('${p.id}', '${p.name}', '${p.category}')" title="AI SEO">
                                    <i class="fas fa-magic"></i>
                                </button>
                                <button class="btn" style="padding: 5px 8px; font-size: 0.75rem; background:#ff4757; color:white; border:none;" onclick="deleteProduct('${p.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Inventory Tab
                const invRes = await fetch('/api/interests');
                const interests = await invRes.json();

                const invList = document.getElementById('inventory-list');
                invList.innerHTML = allProducts.map(p => {
                    const demand = interests[p.id] || [];
                    return `
                    <tr>
                        <td>${p.name}</td>
                        <td>Rs. ${p.price}</td>
                        <td>
                             <span class="badge ${p.inStock ? 'badge-success' : 'badge-danger'}">${p.inStock ? 'Available' : 'Sold Out'}</span>
                        </td>
                        <td>
                            <i class="fas fa-users" style="color: #666; margin-right: 5px;"></i> 
                            <b>${demand.length || 0}</b> people waitlisted
                            ${demand.length > 0 ? `<br><a href="javascript:void(0)" onclick='viewLeadsSection("${p.id}", "${p.name}")' style="font-size: 0.7rem; color: var(--accent); text-decoration: underline;">View Contact Details</a>` : ''}
                        </td>
                        <td>
                            <button class="btn" style="padding: 5px 12px; font-size: 0.75rem; background: ${p.inStock ? '#eb3b5a' : '#1fb468'}" 
                                onclick="toggleStock('${p.id}', ${!p.inStock})">
                                ${p.inStock ? 'Mark Out of Stock' : 'Mark In Stock'}
                            </button>
                        </td>
                    </tr>
                `}).join('');

                document.getElementById('stat-products').textContent = allProducts.length;

            } catch (err) { console.error(err); }
        }

        async function toggleStock(id, status) {
            const res = await fetch(`/api/products/${id}/stock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ inStock: status })
            });
            const data = await res.json();
            if (data.success) {
                showToast('Stock Status Updated!');
                loadProducts();
            } else {
                showToast('‚ùå Error: ' + data.message);
            }
        }

        async function loadOrders() {
            const res = await fetch('/api/orders');
            allOrders = await res.json();
            const tbody = document.getElementById('admin-order-list');

            if (allOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No orders yet. Start marketing to see them here!</td></tr>';
                return;
            }

            tbody.innerHTML = allOrders.map(o => {
                let badgeClass = 'badge-info';
                if (o.status === 'Shipped') badgeClass = 'badge-warning';
                if (o.status === 'Delivered') badgeClass = 'badge-success';
                if (o.status === 'Cancelled') badgeClass = 'badge-danger';

                return `
                <tr>
                    <td>#${o.id.slice(-6).toUpperCase()}</td>
                    <td>${new Date(o.date).toLocaleDateString()}</td>
                    <td>Rs. ${o.total.toLocaleString()}</td>
                    <td><span class="badge ${badgeClass}">${o.status}</span></td>
                    <td><button class="btn btn-outline" style="padding: 5px 10px;" onclick="viewOrderItems('${o.id}')">View Items</button></td>
                </tr>
            `}).join('');

            document.getElementById('stat-orders').textContent = allOrders.length;
        }

        function viewOrderItems(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            currentOrderId = orderId; // track globally for modal actions
            document.getElementById('order-id-display').textContent = '#' + orderId.slice(-6).toUpperCase();
            document.getElementById('order-status-select').value = order.status;
            document.getElementById('order-total-display').textContent = 'Rs. ' + order.total.toLocaleString();

            const list = document.getElementById('order-items-list');
            const items = order.cart || order.items || [];
            list.innerHTML = items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>Rs. ${item.price.toLocaleString()}</td>
                    <td>${item.quantity}</td>
                    <td>Rs. ${(item.price * item.quantity).toLocaleString()}</td>
                </tr>
            `).join('');

            document.getElementById('order-items-modal').style.display = 'flex';
        }

        function closeOrderItems() {
            document.getElementById('order-items-modal').style.display = 'none';
        }

        async function updateOrderStatusFromModal() {
            const status = document.getElementById('order-status-select').value;
            const res = await fetch(`/api/orders/${currentOrderId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            const data = await res.json();
            if (data.success) {
                showToast(`Order status updated to: ${status}`);
                loadOrders(); // Refresh background list
            }
        }

        function notifyStatusWhatsApp() {
            const order = allOrders.find(o => o.id === currentOrderId);
            if (!order) return;

            const status = order.status;
            let message = "";

            if (status.includes("Pending")) {
                message = `Hi! This is Taj Sons. We've received your order #${order.id.slice(-6).toUpperCase()}. We'll process it soon! Total: Rs. ${order.total}`;
            } else if (status === "Processing") {
                message = `Hi! Your order #${order.id.slice(-6).toUpperCase()} is now being processed at Taj Sons. üõ†Ô∏è`;
            } else if (status === "Shipped") {
                message = `Great news! Your order #${order.id.slice(-6).toUpperCase()} has been SHIPPED. üöö Expect it in 3-5 days.`;
            } else if (status === "Delivered") {
                message = `Your order #${order.id.slice(-6).toUpperCase()} has been DELIVERED. üéÅ We hope you love your new organizers!`;
            } else {
                message = `Update regarding your order #${order.id.slice(-6).toUpperCase()}: Status is now ${status}.`;
            }

            const waLink = `https://wa.me/923001234567?text=${encodeURIComponent(message)}`;
            window.open(waLink, '_blank');
        }

        function calculateStats() {
            const revenue = allOrders.reduce((sum, o) => sum + o.total, 0);
            document.getElementById('stat-revenue').textContent = 'Rs. ' + revenue.toLocaleString();
            document.getElementById('stat-orders').textContent = allOrders.length;
            document.getElementById('stat-products').textContent = allProducts.length;
        }

        // SEO Logic
        let currentProductId = null;
        function openSeo(id, name, category) {
            currentProductId = id;
            document.getElementById('seo-modal').style.display = 'flex';
            document.getElementById('seo-product-name').textContent = name;
            document.getElementById('seo-result').style.display = 'none';
            document.getElementById('seo-loading').style.display = 'block';

            fetch('/api/generate-seo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productName: name, category, apiKey: CONFIG.geminiApiKey })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('seo-loading').style.display = 'none';
                    document.getElementById('seo-result').style.display = 'block';
                    document.getElementById('seo-desc').value = data.description;
                    document.getElementById('seo-tags').value = data.tags;
                })
                .catch(() => {
                    alert('Connection to Gemini AI Lost. Make sure your laptop/server is running.');
                    closeSeo();
                });
        }

        function closeSeo() { document.getElementById('seo-modal').style.display = 'none'; }

        async function saveSeo() {
            const description = document.getElementById('seo-desc').value;
            const tags = document.getElementById('seo-tags').value;

            await fetch(`/api/products/${currentProductId}/seo`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description, tags })
            });

            alert('AI Description Saved Successfully!');
            closeSeo();
            loadProducts();
        }

        async function scanProducts() {
            showConfirm(
                "Scan Products?",
                "Search 'Products' folder for new inventory? This will add any new images found.",
                "fas fa-sync",
                "var(--accent)",
                async () => {
                    const res = await fetch('/api/scan-products');
                    const data = await res.json();
                    showToast(`Found ${data.added} new products!`);
                    loadProducts();
                }
            );
        }

        async function viewLeadsSection(productId, productName) {
            currentLeadsProductId = productId;
            currentLeadsProductName = productName;
            document.getElementById('inventory-main-view').style.display = 'none';
            document.getElementById('inventory-leads-view').style.display = 'block';
            document.getElementById('leads-product-name-heading').textContent = productName;

            const res = await fetch('/api/interests');
            const interests = await res.json();
            const leads = interests[productId] || [];

            const list = document.getElementById('full-leads-list');

            if (leads.length === 0) {
                list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 50px;">No leads found.</td></tr>';
            } else {
                list.innerHTML = leads.reverse().map(l => {
                    const cleanPhone = l.phone.replace(/\D/g, '');
                    const waLink = `https://wa.me/${cleanPhone}?text=Hi ${l.name}, you were interested in ${productName} at Taj Sons. It's back in stock!`;

                    return `
                    <tr>
                        <td><b>${l.name}</b></td>
                        <td>${l.phone}</td>
                        <td>${new Date(l.date).toLocaleDateString()}</td>
                        <td>
                            <a href="${waLink}" target="_blank" class="btn" style="padding: 6px 15px; font-size: 0.75rem; background: #25D366; display: flex; align-items: center; gap: 8px; width: fit-content;">
                                <i class="fab fa-whatsapp"></i> Message
                            </a>
                        </td>
                    </tr>
                    `;
                }).join('');
            }

            // handler is now static in HTML calling clearInterests()
        }

        function backToInventory() {
            document.getElementById('inventory-main-view').style.display = 'block';
            document.getElementById('inventory-leads-view').style.display = 'none';
            loadProducts();
        }

        async function clearInterests() {
            const productId = currentLeadsProductId;
            const productName = currentLeadsProductName;
            if (!productId) return;

            showConfirm(
                "Clear Waitlist?",
                `Are you sure you want to clear ALL waitlist leads for ${productName}? This cannot be undone.`,
                "fas fa-exclamation-triangle",
                "#ff4757",
                async () => {
                    const res = await fetch('/api/interests/clear', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`Leads for ${productName} cleared!`);
                        backToInventory();
                    } else {
                        alert('‚ùå Error clearing leads.');
                    }
                }
            );
        }

        function filterAdminProducts() {
            const query = document.getElementById('admin-product-search').value.toLowerCase();
            const rows = document.querySelectorAll('#admin-product-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Product CRUD Logic
        function openAddProductModal() {
            document.getElementById('product-modal-title').textContent = "Add New Product";
            document.getElementById('edit-product-id').value = "";
            document.getElementById('product-form').reset();
            document.getElementById('edit-img-note').style.display = 'none';
            // Reset slots
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`prev-${i}`).style.display = 'none';
                document.getElementById(`icon-${i}`).style.display = 'block';
            }
            document.getElementById('product-modal').style.display = 'flex';
        }

        function openEditProductModal(id) {
            const p = allProducts.find(prod => prod.id === id);
            if (!p) return;

            document.getElementById('product-modal-title').textContent = "Edit Product";
            document.getElementById('edit-product-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-category').value = p.category;
            document.getElementById('p-desc').value = p.description || "";
            document.getElementById('edit-img-note').style.display = 'block';

            // Reset slots for edit
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`prev-${i}`).style.display = 'none';
                document.getElementById(`icon-${i}`).style.display = 'block';
            }
            document.getElementById('product-modal').style.display = 'flex';
        }

        function previewSlot(num) {
            const input = document.getElementById(`p-image-${num}`);
            const prev = document.getElementById(`prev-${num}`);
            const icon = document.getElementById(`icon-${num}`);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    prev.src = e.target.result;
                    prev.style.display = 'block';
                    icon.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }


        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-product-id').value;
            const formData = new FormData();
            formData.append('name', document.getElementById('p-name').value);
            formData.append('price', document.getElementById('p-price').value);
            formData.append('category', document.getElementById('p-category').value);
            formData.append('description', document.getElementById('p-desc').value);

            // Collect from slots
            for (let i = 1; i <= 5; i++) {
                const f = document.getElementById(`p-image-${i}`).files[0];
                if (f) formData.append('images', f);
            }

            const url = id ? `/api/products/${id}` : '/api/products';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method, body: formData });
                const data = await res.json();
                if (data.success) {
                    showToast('Product saved successfully!');
                    closeProductModal();
                    loadProducts();
                }
            } catch (err) {
                showToast('‚ùå Error saving product.');
            }
        }

        async function deleteProduct(id) {
            const p = allProducts.find(prod => prod.id === id);
            const name = p ? p.name : "this product";

            showConfirm(
                "Delete Product?",
                `Are you sure you want to remove "${name}" from your store?`,
                "fas fa-trash-alt",
                "#ff4757",
                async () => {
                    try {
                        const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            showToast("Product deleted successfully!");
                            loadProducts();
                        } else {
                            alert('‚ùå Error: ' + (data.error || 'Could not delete product.'));
                        }
                    } catch (err) {
                        alert('‚ùå Error deleting product. Check network.');
                    }
                }
            );
        }

        loadProducts();
    </script>
</body>

</html>